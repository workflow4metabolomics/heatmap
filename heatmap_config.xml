<tool id="Heatmap" name="Heatmap" version="2.1.2">
  <description>Heatmap of the dataMatrix</description>
  
  <requirements>
    <requirement type="package" version="3.2.2">R</requirement>
    <requirement type="package">r-batch</requirement>
  </requirements>
  
  <command><![CDATA[
  Rscript $__tool_directory__/heatmap_wrapper.R
  dataMatrix_in "$dataMatrix_in"
  sampleMetadata_in "$sampleMetadata_in"
  variableMetadata_in "$variableMetadata_in"
  
  cutSamN "$cutSamN"
  cutVarN "$cutVarN"
  
  #if $advPar.oppC == "full"
  scaL "$advPar.scaL"
  cexN "$advPar.cexN"
  #end if
  
  dataMatrix_out "$dataMatrix_out"
  sampleMetadata_out "$sampleMetadata_out"
  variableMetadata_out "$variableMetadata_out"
  figure "$figure"
  information "$information"
  ]]></command>
  
  <inputs>
    <param name="dataMatrix_in" type="data" label="Data matrix file" help="" format="tabular" />
    <param name="sampleMetadata_in" type="data" label="Sample metadata file" help="" format="tabular" />
    <param name="variableMetadata_in" type="data" label="Variable metadata file" help="" format="tabular" />
    
    <param name="cutSamN" label="Number of sample clusters to identify" type="select" help="">
      <option value="1" selected="true">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
      <option value="14">14</option>
      <option value="15">15</option>
    </param>
    
    <param name="cutVarN" label="Number of variable clusters to identify" type="select" help="">
      <option value="1" selected="true">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
      <option value="14">14</option>
      <option value="15">15</option>			
    </param>
		
    <conditional name="advPar">
      <param name="oppC" type="select" label="Advanced parameters" >
	<option value="default" selected="true">Use default</option>
	<option value="full">Full list</option>
      </param>
      <when value="default">
        <param name="scaL" type="hidden" value="TRUE"/>
	<param name="cexN" type="hidden" value="0.8"/>
      </when>	
      <when value="full">
	<param name="scaL" label="Variable standardization (for plotting only)" type="select" help="Standardization is performed after the clustering for display only (may enhance contrast) and does not modify cluster computation nor intensities in the output files">
	  <option value="TRUE" selected="true">yes</option>
	  <option value="FALSE">no</option>
	</param>
	<param name="cexN" label="Size of labels" type="select" help="">
	  <option value="0.5">0.5</option>
	  <option value="0.6">0.6</option>
	  <option value="0.7">0.7</option>
	  <option value="0.8" selected="true">0.8</option>
	  <option value="0.9">0.9</option>
	  <option value="1">1</option>
	</param>
      </when>
    </conditional>

  </inputs>
	
  <outputs>
    <data name="dataMatrix_out" label="${tool.name}_${dataMatrix_in.name}" format="tabular" ></data>
    <data name="sampleMetadata_out" label="${tool.name}_${sampleMetadata_in.name}" format="tabular" ></data>
    <data name="variableMetadata_out" label="${tool.name}_${variableMetadata_in.name}" format="tabular" ></data>
    <data name="figure" label="${tool.name}_figure.pdf" format="pdf"/>
    <data name="information" label="${tool.name}_information.txt" format="txt"/>
  </outputs>	

  <tests>
    <test>
      <param name="dataMatrix_in" value="input-dataMatrix.tsv"/>
      <param name="sampleMetadata_in" value="input-sampleMetadata.tsv"/>
      <param name= "variableMetadata_in" value="input-variableMetadata.tsv"/>
      <param name="cutSamN" value="1"/>
      <param name="cutVarN" value="3"/>
      <param name="scaL" value="TRUE"/>
      <param name="cexN" value="0.8"/>
      <output name="variableMetadata_out" file="output-variableMetadata.tsv"/>
    </test>
  </tests>
  
  <help>

.. class:: infomark
    
| **Tool update: See the 'NEWS' section at the bottom of the page**

---------------------------------------------------

.. class:: infomark

**Author** Etienne Thevenot (W4M Core Development Team, MetaboHUB Paris, CEA)

---------------------------------------------------

.. class:: infomark

**References**

| Thevenot E., Roux A., Xu Y., Ezan E., and Junot C. Analysis of the human adult urinary metabolome variations with age, body mass index and gender by implementing a comprehensive workflow for univariate and OPLS statistical analyses. *submitted*.
| R Core Team (2013). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria (http://www.r-project.org)
|

---------------------------------------------------

.. class:: infomark

**Tool updates**

See the **NEWS** section at the bottom of this page
  
---------------------------------------------------


========================
Heatmap
========================

-----------
Description
-----------

 | Performs hierarchical clustering on both the samples (rows) and variables (columns) of the dataMatrix
 | Displays the dataMatrix with sorted rows and samples and the dendrograms (heatmap)
 | In the output dataMatrix, sampleMetadata and variableMetadata files sample and variables are sorted according to the dendrograms
 | Optionally, indicates the groups of samples and/or variables obtained by cutting the dendrograms into a specific number of partitions
 |
 | Note: 1) Computations rely on the 'hclust' function. The dissimilarity is 1 - cor (where cor is the Spearman correlation) and the 'ward.D' aggregating method is used.
 |       2) A "blue-orange-red" palette is generated with the function 'colorRampPalette'; **By default, variables are standardized (mean-centered and unit-scaled) to enhance contrast on the figure**; standardization can be turned off by using the full list of parameters; in any case, standardizing is performed after the computation of clusters, for display only
 |       3) When a specific number of sample and/or variable groups (i.e. > 1) are selected, the group numbers are indicated on the plot and in an additional 'heat_clust" column in the sampleMetadata and/or variableMetadata
 |       4) Example of computation times: for 126 variables: a few seconds; for 4324 variables: 30 min
 |
 

-----------------
Workflow position
-----------------

| In the workflow example below, the structure of the dataset (dataMatrix) is visualized by using first the "Quality Metrics" (for checking potential signal drift, sample outliers, etc.), then the "Heatmap" (for correlations between samples or variables), and finally the "Multivariate" (for PCA or PLS) modules.
|

.. image:: heatmap_workflowPositionImage.png
        :width: 600



-----------
Input files
-----------

+--------------------------+-------------+
| File type                |   Format    |
+==========================+=============+
| 1 : Data matrix          |   tabular   |
+--------------------------+-------------+
| 2 : Sample metadata      |   tabular   |
+--------------------------+-------------+
| 3 : Variable metadata    |   tabular   |
+--------------------------+-------------+

|
| Required formats for the dataMatrix, sampleMetadata and variableMetadata files are described in the HowTo entitled 'Format Data For Postprocessing' available on the main page of Workflow4Metabolomics.org; formats of the three files can be further checked with the 'Check Data' module (in the 'Quality Control' section)
|

----------
Parameters
----------

Number of sample clusters
	| By default (cluster = 1), only dendrograms are displayed; when a specific number of sample clusters is selected, the sample dendrogram is cut at the corresponding level: the sample groups are displayed on the dendrogram and a "heat_clust" column is added in the sampleMetadata file with the group of each sample
	|
	
Number of variable clusters
	| Same as above for variables
	|
	
Standardization (Full list)
	| By default, variables are standardized for display to enhance contrast of the heatmap (note that standardization is performed after the clustering for display only and does not modify cluster computation nor intensities in the output files)
	| 
	
Size of labels (Full list)
	| The size of sample and variable names on the heatmap is 0.8 (note that names with more than 14 characters are truncated); this number may be lowered (or uppered) in case of many (few) names to display


------------
Output files
------------

dataMatrix_out.tabular
	| dataMatrix file with rows and columns sorted according to the dendrogram
	| 

sampleMetadata_out.tabular
	| sampleMetadata file with rows sorted according to the sample dendrogram; in case a number of sample groups is specified, and additional "heat_clust" column is added with the cluster group of each sample
	| 
	
variableMetadata_out.tabular
	| variableMetadata file with rows sorted according to the variable dendrogram; in case a number of variable groups is specified, and additional "heat_clust" column is added with the cluster group of each variable
	| 

figure.pdf
	| Heatmap
	| 	

information.txt
	| File with all messages and warnings generated during the computation
	|
	
---------------------------------------------------

---------------
Working example
---------------

.. class:: infomark

See the **W4M00001a_sacurine-subset-statistics** shared history in the **Shared Data/Published Histories** menu

---------------------------------------------------

----
NEWS
----

CHANGES IN VERSION 2.1.2
========================

INTERNAL MODIFICATIONS

Creating additional files for planemo and travis running and installation validation

 </help>
 
 <citations>
   <citation type="bibtex">@Article{Thevenot2015,
   Title                    = {Analysis of the human adult urinary metabolome variations with age, body mass index and gender by implementing a comprehensive workflow for univariate and OPLS statistical analyses},
   Author                   = {Thevenot, Etienne A. and Roux, Aurelie and Xu, Ying and Ezan, Eric and Junot, Christophe},
   Journal                  = {Journal of Proteome Research},
   Year                     = {2015},
   Note                     = {PMID: 26088811},
   Number                   = {8},
   Pages                    = {3322-3335},
   Volume                   = {14},
   
   Doi                      = {10.1021/acs.jproteome.5b00354},
   Url                      = {http://pubs.acs.org/doi/full/10.1021/acs.jproteome.5b00354}
   }</citation>
   
 </citations>
 
---------------
Working example
---------------

Input files
===========

| **To generate the "dataMatrix", "sampleMetadata" and "variableMetadata" files:**
|   **1) copy/paste the values below in three distinct .txt files**
|   **2) use the "Get Data" / "Upload File" in the "Tools" (left) panel from the Galaxy / ABiMS page by choosing:**
|     **a) File Format: 'tabular'**
|     **b) Convert spaces to tabs: 'Yes'**
| 

**dataMatrix file**::

	dataMatrix HU_017 HU_028 HU_034 HU_051 HU_060 HU_078 HU_091 HU_093 HU_099 HU_110 HU_130 HU_134 HU_138 HU_149 HU_152 HU_175 HU_178 HU_185 HU_204 HU_208
	HMDB03193 76043 412165 44943 27242 436566 173175 242549 57066 559869 3732 339188 471368 262271 127285 451270 212500 79673 NA 891129 43907
	HMDB01101 30689 6877586 52217 3158 10789748 229568 4763576 3878773 976436 831937 608298 1605075 72021 442510 1107705 1464339 31250 2724553 72900 32742
	HMDB10348 47259 544877 60885 34582 529874 168264 176500 76457 610110 16262 279156 524468 451573 591487 433529 161069 214392 13781 1580343 39315
	HMDB59717 357351 1030464 301983 67604 306862 1028110 1530493 270027 1378535 289677 808334 1132813 871209 895435 715190 1563158 784738 146195 994336 239030
	HMDB00822 483755 579287 1132413 157113 1577570 1469735 1085454 477909 814755 245417 610681 763706 2406336 827531 992508 569605 355321 150259 1334200 271010
	HMDB13189 2644620 727587 1661412 619181 136278 2755434 593863 837865 3526136 2003278 1608814 3446611 1941527 113937 3132404 2893445 2092753 1034666 1517319 841661
	HMDB00299 250551 1046138 456162 159386 1013302 808657 614370 250403 768004 242085 504108 1014041 1362408 1057660 1110050 566050 411886 142233 1992420 284775
	HMDB00191 560002 771533 575790 392284 888498 785428 645785 591569 960658 910201 639437 1092885 1409045 2292023 1246459 1945577 710519 773384 1061418 622898
	HMDB00518 34236 58249 85944 NA 342102 129886 175800 13154 230242 NA 440223 315368 10657 419508 48673 28361 514579 23108 867108 73831
	HMDB00715 1252089 2547452 905408 371059 4983588 5140022 2658555 814523 2558923 859466 4184204 3865723 3236644 2615560 3820724 3577833 2295288 625924 7517724 1341900
	HMDB01032 2569205 26023086 1604999 430453 8103558 26222916 257139 675754 59906109 263055 31151730 18648127 14989438 1554658 20249262 5588731 871010 15920 9120781 44276
	HMDB00208 747080 13420742 595872 1172376 7172632 3143654 4059767 1433702 5593888 5402629 2477288 3346077 4230072 7621236 8960828 10335722 7037373 1574738 3359238 2540044
	HMDB04824 374028 1144386 539206 178517 1046190 959381 605191 310260 1253319 477259 477995 825691 1157093 1089284 1411802 1020206 782673 346761 1824553 387811
	HMDB00512 53304 319783 280560 85009 1333877 556003 590779 209285 342532 198512 569970 525240 246282 1140422 542345 1171008 827723 222953 438839 85554
	HMDB00251 368600 616555 94936 622468 180988 293988 352855 767894 268331 167246 310918 1248919 577184 10985 335711 403815 80614 63393 454489 616061

	
**sampleMetadata file**::

	sampleMetadata injectionOrder mode age bmi gender
	HU_017 2 pos 41 23.03 M
	HU_028 7 pos 41 23.92 F
	HU_034 9 pos 52 23.37 M
	HU_051 20 pos 24 23.23 F
	HU_060 24 pos 55 28.72 F
	HU_078 34 pos 46 25.18 M
	HU_091 42 pos 61 26.12 M
	HU_093 43 pos 53 21.71 M
	HU_099 46 pos 23 21.3 M
	HU_110 53 pos 50 20.9 F
	HU_130 63 pos 33 26.06 M
	HU_134 67 pos 48 22.89 M
	HU_138 68 pos 42 21.88 M
	HU_149 72 pos 35 19.49 F
	HU_152 75 pos 26 17.58 F
	HU_175 87 pos 35 21.26 F
	HU_178 88 pos 60 32.87 F
	HU_185 95 pos 42 21.09 F
	HU_204 104 pos 31 29.06 M
	HU_208 106 pos 27 18.61 F

**variableMetadata file**::

	variableMetadata name
	HMDB03193 Testosterone_glucuronide
	HMDB01101 p-Anisic_acid
	HMDB10348 Dehydroepiandrosterone_3-glucuronide
	HMDB59717 Glu-Val
	HMDB00822 p-Hydroxymandelic_acid
	HMDB13189 3-Indole_carboxylic_acid_glucuronide
	HMDB00299 Xanthosine
	HMDB00191 L-Aspartic_acid
	HMDB00518 Chenodeoxycholic_acid
	HMDB00715 Kynurenic_acid
	HMDB01032 Dehydroepiandrosterone_sulfate
	HMDB00208 Oxoglutaric_acid
	HMDB04824 N2,N2-Dimethylguanosine
	HMDB00512 N-Acetyl-L-phenylalanine
	HMDB00251 Taurine


Parameters
==========

+-----------------------------+---------+
| Sample clusters             |    4    |
+-----------------------------+---------+
| Variable clusters           |    3    |
+-----------------------------+---------+


Output files
============

+---------------------------+------------+
| File                      |   Format   |
+===========================+============+
| 1)  Data matrix           |   tabular  |
+---------------------------+------------+
| 2)  Sample metadata       |   tabular  |
+---------------------------+------------+
| 3)  Variable metadata     |   tabular  |
+---------------------------+------------+
| 4)  Figure                |    pdf     |
+---------------------------+------------+

Figure output
=============

| You should obtain with this very simplified dataset the following figure:
|

.. image:: heatmap_workingExampleImage.png
        :width: 600

---------------------------------------------------

----
NEWS
----

CHANGES IN VERSION 2.1.1
========================

Internal replacement of the as.hclust function which happened to produce error messages

 
  
</tool>
